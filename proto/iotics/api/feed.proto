// Copyright (c) 2019-2020 Iotic Labs Ltd. All rights reserved.

// Iotics Web protocol definitions (feed)
syntax = "proto3";

import "google/protobuf/wrappers.proto";
import "iotics/api/common.proto";

package iotics.api;

option csharp_namespace = "Iotics.Api";
option go_package = "github.com/Iotic-Labs/iotic-go-proto-qapi/iotics/api;ioticsapi";
option java_multiple_files = true;
option java_outer_classname = "FeedProto";
option java_package = "com.iotics.api";
option objc_class_prefix = "IAX";
option php_namespace = "Iotics\\Api";

// ---------------------------------------------------------------------------------------------------------------------


// Create a feed owned by the provided twin.
// A twin may have one or more feeds. Any twin can subscribe to a feed (access control permitting).
// A feed generates data in a 1-to-many relationship: one feed may produce data that is used by many consumers (twins).
service FeedAPI {
  // Creates a feed owned by a twin. (Idempotent)
  // Deprecation: CreateFeedRequest.payload.storeLast is no longer used. Please use UpdateFeed or UpsertTwin to set feed storeLast value.
  // Deprecation: CreateFeedResponse.payload.alreadyCreated is no longer set (the service remains idempotent).
  rpc CreateFeed(CreateFeedRequest) returns (CreateFeedResponse) {}

  // Deletes a feed owned by a twin. (Idempotent)
  rpc DeleteFeed(DeleteFeedRequest) returns (DeleteFeedResponse) {}

  // Updates attributes of a feed, including its metadata.
  rpc UpdateFeed(UpdateFeedRequest) returns (UpdateFeedResponse) {}

  // Shares a new sample of data for the given feed which any (interest) subscribers can receive.
  rpc ShareFeedData(ShareFeedDataRequest) returns (ShareFeedDataResponse) {}

  // List all feeds owned by a twin.
  rpc ListAllFeeds(ListAllFeedsRequest) returns (ListAllFeedsResponse) {}

  // Describe feed.
  rpc DescribeFeed(DescribeFeedRequest) returns (DescribeFeedResponse) {}
}

// A feed representation.
message Feed {
  // feed identifier (unique within the scope of a twin identifier)
  FeedID id = 1;
  // twin unique identifier (twin to which the feed belongs)
  TwinID twinId = 2;
}

// CreateFeedRequestCreate is used to create a new feed in a given twin.
// Deprecation: CreateFeedRequest.payload.storeLast is no longer used. Please use UpdateFeed or UpsertTwin to set feed storeLast value.
message CreateFeedRequest {
  // Payload describes the data needed to create a feed.
  message Payload {
    // ID of the feed to create
    FeedID feedId = 1;
    // StoreLast indicates if the last received value should be stored of not
    // Deprecated: storeLast can be set using UpdateFeedRequest or UpsertFeedWithMeta
    bool storeLast = 2;
  }
  // Arguments describes the mandatory arguments to identify the twin the feed belongs to.
  message Arguments {
    // Identifier of the twin owning this feed
    TwinID twinId = 1;
  }

  // CreateFeedRequest headers
  Headers headers = 1;
  // CreateFeedRequest mandatory arguments
  Arguments args = 2;
  // CreateFeedRequest payload
  Payload payload = 3;
}

// CreateFeedResponse describes a created feed.
// Deprecation: CreateFeedResponse.payload.alreadyCreated is no longer set (the service remains idempotent).
message CreateFeedResponse {
  // CreateFeedResponse payload.
  message Payload {
    // The created feed
    Feed feed = 1;
    // AlreadyCreated indicates if the feed already existed (the create is idempotent)
    // Deprecated: no longer set
    bool alreadyCreated = 2;
  }
  // CreateFeedResponse headers
  Headers headers = 1;
  // CreateFeedResponse payload
  Payload payload = 2;
}

// ---------------------------------------

// DeleteFeedRequest is used to delete a feed from a given twin.
message DeleteFeedRequest {
  // DeleteFeedRequest arguments.
  message Arguments {
    // Feed to delete
    Feed feed = 1;
  }
  // DeleteFeedRequest headers
  Headers headers = 1;
  // DeleteFeedRequest mandatory arguments
  Arguments args = 2;
}


// DeleteFeedResponse describes a deleted feed.
message DeleteFeedResponse {
  // DeleteFeedResponse payload.
  message Payload {
    Feed feed = 1;
  }
  // DeleteFeedResponse headers
  Headers headers = 1;
  // DeleteFeedResponse payload
  Payload payload = 2;
}

// ---------------------------------------

// UpdateFeedRequest is used to update attributes (including metadata) of a given feed.
message UpdateFeedRequest {
  // Soft breaking change: move to common once ready for real breaking change

  // PropertyUpdate describes the update of feed properties.
  // Can be used to add, replace, or delete properties. The order of operations is:
  // clearedAll (if True), deleted, deletedByKey, added.
  // Note that internal properties (such as location) cannot be modified here.
  message PropertyUpdate {

    // Delete all properties currently set on the twin.
    bool clearedAll = 1;

    // Delete specific exact properties (by key and value). This operation is ignored if clearAll is True.
    repeated Property deleted = 2;
    // Delete any properties with the given keys (predicates). This operation is ignored if clearAll is True.
    repeated string deletedByKey = 3;
    // Adds the given properties
    repeated Property added = 4;
  }

  // UpdateFeedRequest payload. One or more fields can be provided, depending on what needs to be updated.
  // Note that the specified metadata changes are applied in the following order:
  // tags, values, labels, comments
  message Payload {

    // storeLast dictates whether to store the last shared sample of a feed.
    google.protobuf.BoolValue storeLast = 1;
    // tags are the set of tags to add or remove.
    Tags tags = 2;
    // values are descriptive individual data items to add/remove.
    Values values = 3;
    // labels are human-readable set of labels (language-specific) to add or remove.
    LabelUpdate labels = 4;
    // comments are the human-readable extended descriptions (language-specific) to add or remove.
    CommentUpdate comments = 5;
    // Custom properties to add/remove. Internal properties (such as location) cannot be modified here.
    PropertyUpdate properties = 6;
  }

  // UpdateFeedRequest arguments.
  message Arguments {
    Feed feed = 1;
  }

  // UpdateFeedRequest headers
  Headers headers = 1;
  // UpdateFeedRequest arguments
  Arguments args = 2;
  // UpdateFeedRequest payload
  Payload payload = 3;
}

// UpdateFeedResponse is used to indicate a successful update.
message UpdateFeedResponse {
  // UpdateFeedResponse payload.
  message Payload {
    // Updated Twin
    Feed feed = 1;
  }
  // UpdateFeedResponse headers
  Headers headers = 1;
  //UpdateFeedResponse payload
  Payload payload = 2;
}

// ---------------------------------------

// ShareFeedDataRequest is used to share a new sample of data for the given feed.
message ShareFeedDataRequest {

  // ShareFeedDataRequest payload.
  message Payload {
    FeedData sample = 1;
  }
  // ShareFeedDataRequest arguments.
  message Arguments {
    Feed feed = 1;
  }

  // ShareFeedDataRequest headers
  Headers headers = 1;
  // ShareFeedDataRequest arguments
  Arguments args = 2;
  // ShareFeedDataRequest payload
  Payload payload = 3;

}

// ShareFeedDataResponse is used to indicate a successful feed share.
message ShareFeedDataResponse {
  // ShareFeedDataResponse headers
  Headers headers = 1;
}

// ---------------------------------------

// ListAllFeedsRequest is used to list all the feeds owned by a given twin.
message ListAllFeedsRequest {
  // ListAllFeedsRequest mandatory arguments.
  message Arguments {
    // Identifier of the twin owning this feed
    TwinID twinId = 1;
  }
  // ListAllFeedsRequest headers
  Headers headers = 1;
  // ListAllFeedsRequest arguments
  Arguments args = 2;
  // Limit the results according to the value
  // (optional: when not supplied, assume no default limits required - See https://ioticlabs.atlassian.net/browse/FO-1362)
  Range range = 3;
}

// ListAllFeedsResponse describes the list of the feeds owned by a twin.
message ListAllFeedsResponse {
  // ListAllFeedsResponse payload.
  message Payload {
    // List of the feeds owned by the twin
    repeated Feed feeds = 1;

  }
  // ListAllFeedsResponse headers
  Headers headers = 1;
  // ListAllFeedsResponse payload
  Payload payload = 2;
}

// Description of twin: Provides public metadata lookup for individual resources.
message DescribeFeedRequest {

  // Only one action argument is necessary.
  message Arguments {
    // Feed to describe
    Feed feed = 1;

    // optional HostID to describe a remote feed
    HostID remoteHostId = 2;
  }
  Headers headers = 1;
  // Language code for labels and comments. If set, only the label and comment in the given language will be returned
  // instead of all. This field does not apply to values and tags which are always returned in full.
  google.protobuf.StringValue lang = 2;
  // DescribeFeedRequest mandatory arguments
  Arguments args = 3;
}
// Describe feed response.
message DescribeFeedResponse {
  Headers headers = 1;


  // Metadata result databag.
  message MetaResult {
    // Labels in all languages set for the feed. (Or: Only label in chosen language, if lang field was specified in the
    // request.)
    repeated LangLiteral labels = 1;
    // values semantically describing the share payload of Feed or expected arguments for a Control request
    repeated Value values = 2;
    repeated string tags = 3;
    // Comments in all languages set for the feed. (Or: Only comment in chosen language, if lang field was specified in
    // the request.)
    repeated LangLiteral comments = 4;
    // Whether this feed might have its most recent data sample stored. If so, it can be retrieved via FetchLastStored
    // request. (See interest API)
    bool storeLast = 5;

    // Custom properties associated with this feed.
    repeated Property properties = 6;
  }

  // DescribeFeedResponse payload.
  message Payload {
    Feed feed = 1;
    MetaResult result = 2;
    HostID remoteHostId = 3;
  }
  Payload payload = 2;
}

// UpsertFeedWithMeta is used to describe the full feed state. Used in UpsertTwinRequest.
message UpsertFeedWithMeta {
  // Id of the feed to create/update
  string id = 1;

  // Labels are human-readable set of labels (language-specific) to set
  repeated LangLiteral labels = 2;

  // Comments are human-readable set of labels (language-specific) to set
  repeated LangLiteral comments = 3;

  // storeLast dictates whether to store the last shared sample of the feed. Default 'False'
  bool storeLast = 4;

  // values to set
  repeated Value values = 5;

  // feed properties to set
  repeated Property properties = 6;
}
