// Copyright (c) 2019-2020 Iotic Labs Ltd. All rights reserved.

// Iotics Web protocol defintions (search)


syntax = "proto3";

// Scalar wrappers (for detecting presence as opposed to dealing only with default value)
// import "third_party/googleapis/google/api/annotations.proto";
import "google/protobuf/wrappers.proto";
import "google/protobuf/timestamp.proto";
import "google/rpc/status.proto";
import "common/model.proto";
import "feed/model.proto";

package search;

option go_package = "github.com/Iotic-Labs/iotic-go-proto-qapi/search";

// ---------------------------------------------------------------------------------------------------------------------

// ResponseType describes the type of the search response.
// - FULL - Returns full responses including twins and feeds identifiers, labels/comments (for all languages if no language provided), properties and location
// - LOCATED - Returns located responses including twins identifier, location and label (for the provided language or default)
// - MINIMAL - Returns minimal responses including twins identifier only
enum ResponseType {
  FULL = 0;
  LOCATED = 1;
  MINIMAL = 2;
}

// SearchRequest describes a search request used for both synchronous and asynchronous search.
message SearchRequest {
  // Search request payload.
  message Payload {
    // Expected response type
    ResponseType responseType = 1;
    // UTC time (millis from epoch / unix time) when this search request has to be considered expired.
    google.protobuf.Timestamp expiryTimeout = 2;

    // Search request filters, any of these can be used in combination or on their own.
    message Filter {
      // Text filtering. One or more keywords which must match either text from twin/feed labels/comments (in the given
      // language). Note that any (rather than all) of the keywords will produce a match.
      google.protobuf.StringValue text = 1;
      // Location filtering: area within which twins must be located
      common.GeoCircle location = 2;
      // Properties filtering: one or more exact properties, all of which twins must have.
      repeated common.Property properties = 3;
    }
    // Search Request filters
    Filter filter = 3;
  }
  // Search request headers
  common.Headers headers = 1;

  // Search request scope
  common.Scope scope = 2;

  // Search request lang. It implies both search and result text language
  google.protobuf.StringValue lang = 3;

  // Search request payload
  Payload payload = 6;

  // Search request range
  common.Range range = 20;
}

// ---------------------------------------------------------------------------------------------------------------------

// SearchResponse describes a result associated to a search request.
// It contains all the matching twins/feeds according to the request scope/range/lang/filters in the expected response type format.
// In the decentralised iotics operating environment, each node in the network generates a response and the client is expected to
// receive a stream of response messages.
message SearchResponse {
  // Search response feed details. Included with response type: FULL.
  message FeedDetails {
    // Feed
    feed.Feed feed = 1;
    // The feed human readable label in the language specified in the request (if set)
    string label = 2;
    // whether offers the ability to store last received value
    bool storeLast = 3;
  }

  // Search response twin details.
  message TwinDetails {
    // Twin identifier. Included with response type: FULL, LOCATED and MINIMAL
    common.TwinID id = 1;
    // Twin location (if set). Included with response type: FULL and LOCATED
    common.GeoLocation location = 2;
    // Twin human readable label in the language specified in the request (if set). Included with response type: FULL and LOCATED
    string label = 3;
    // Twin tags. Included with response type: FULL
    repeated string tags = 4;
    // Twin custom properties. Does not include labels/comments/location. Included with response type: FULL
    repeated common.Property properties = 5;
    // Feed details. Included with response type: FULL
    repeated FeedDetails feeds = 10;
  }

  common.Headers headers = 1;
  // Search Response Payload.
  message Payload {
    // Type of the response.
    ResponseType responseType = 1;
    // Response status - if present indicates that this response is invalid
    google.rpc.Status status = 2;
    // Response host identifier - indicates from which host this response comes from
    common.HostID remoteHostId = 4;

    // Matching twins
    repeated TwinDetails twins = 10;
  }
  // Search response payload
  Payload payload = 2;

}

// ---------------------------------------------------------------------------------------------------------------------

// Dispatch Search Response message.
message DispatchSearchResponse{

}
